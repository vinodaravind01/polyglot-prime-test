# Use Maven AWS Corretto as the base image
FROM maven:3.9.6-amazoncorretto-21-debian
# Avoid prompts from apt during build
ENV DEBIAN_FRONTEND=noninteractive
# Update packages and install necessary dependencies
RUN apt-get update
RUN apt-get install -y curl unzip wget sqlite3 git cron graphviz
RUN rm -rf /var/lib/apt/lists/*

RUN java --version
RUN mvn --version

# Clone the specified GitHub repository
WORKDIR /app
ARG REPO_URL
ARG TAG
ARG TECHBD_UDI_DS_PRIME_JDBC_URL
ARG TECHBD_UDI_DS_PRIME_JDBC_USERNAME
ARG TECHBD_UDI_DS_PRIME_JDBC_PASSWORD
ARG SPRING_PROFILES_ACTIVE

ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_0_TENANTID
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_0_SERVER
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_0_PORT
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_0_USERNAME
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_0_PASSWORD
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_1_TENANTID
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_1_SERVER
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_1_PORT
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_1_USERNAME
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_1_PASSWORD
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_2_TENANTID
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_2_SERVER
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_2_PORT
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_2_USERNAME
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_2_PASSWORD
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_3_TENANTID
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_3_SERVER
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_3_PORT
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_3_USERNAME
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_3_PASSWORD
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_4_TENANTID
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_4_SERVER
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_4_PORT
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_4_USERNAME
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_4_PASSWORD
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_5_TENANTID
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_5_SERVER
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_5_PORT
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_5_USERNAME
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_5_PASSWORD
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_6_TENANTID
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_6_SERVER
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_6_PORT
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_6_USERNAME
ARG ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_6_PASSWORD

ARG SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GITHUB_CLIENT_ID
ARG SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GITHUB_CLIENT_SECRET

ARG ORG_TECHBD_SERVICE_HTTP_GITHUB_AUTHZ_USERS_YAML_URL
ARG ORG_TECHBD_SERVICE_HTTP_GITHUB_API_AUTHN_TOKEN

ARG ORG_TECHBD_HUB_PRIME_LOG_FILE

ENV SPRING_PROFILES_ACTIVE=${SPRING_PROFILES_ACTIVE}
ENV ${SPRING_PROFILES_ACTIVE}_TECHBD_UDI_DS_PRIME_JDBC_URL=${TECHBD_UDI_DS_PRIME_JDBC_URL}
ENV ${SPRING_PROFILES_ACTIVE}_TECHBD_UDI_DS_PRIME_JDBC_USERNAME=${TECHBD_UDI_DS_PRIME_JDBC_USERNAME}
ENV ${SPRING_PROFILES_ACTIVE}_TECHBD_UDI_DS_PRIME_JDBC_PASSWORD=${TECHBD_UDI_DS_PRIME_JDBC_PASSWORD}

ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_0_TENANTID=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_0_TENANTID}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_0_SERVER=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_0_SERVER}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_0_PORT=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_0_PORT}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_0_USERNAME=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_0_USERNAME}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_0_PASSWORD=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_0_PASSWORD}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_1_TENANTID=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_1_TENANTID}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_1_SERVER=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_1_SERVER}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_1_PORT=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_1_PORT}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_1_USERNAME=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_1_USERNAME}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_1_PASSWORD=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_1_PASSWORD}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_2_TENANTID=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_2_TENANTID}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_2_SERVER=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_2_SERVER}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_2_PORT=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_2_PORT}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_2_USERNAME=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_2_USERNAME}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_2_PASSWORD=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_2_PASSWORD}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_3_TENANTID=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_3_TENANTID}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_3_SERVER=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_3_SERVER}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_3_PORT=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_3_PORT}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_3_USERNAME=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_3_USERNAME}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_3_PASSWORD=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_3_PASSWORD}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_4_TENANTID=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_4_TENANTID}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_4_SERVER=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_4_SERVER}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_4_PORT=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_4_PORT}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_4_USERNAME=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_4_USERNAME}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_4_PASSWORD=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_4_PASSWORD}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_5_TENANTID=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_5_TENANTID}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_5_SERVER=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_5_SERVER}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_5_PORT=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_5_PORT}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_5_USERNAME=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_5_USERNAME}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_5_PASSWORD=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_5_PASSWORD}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_6_TENANTID=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_6_TENANTID}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_6_SERVER=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_6_SERVER}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_6_PORT=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_6_PORT}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_6_USERNAME=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_6_USERNAME}
ENV ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_6_PASSWORD=${ORG_TECHBD_ORCHESTRATE_SFTP_ACCOUNT_ORCHCTLTS_6_PASSWORD}

ENV SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GITHUB_CLIENT_ID=${SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GITHUB_CLIENT_ID}
ENV SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GITHUB_CLIENT_SECRET=${SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GITHUB_CLIENT_SECRET}

ENV ORG_TECHBD_SERVICE_HTTP_GITHUB_API_AUTHN_TOKEN=${ORG_TECHBD_SERVICE_HTTP_GITHUB_API_AUTHN_TOKEN}
ENV ORG_TECHBD_SERVICE_HTTP_GITHUB_AUTHZ_USERS_YAML_URL=${ORG_TECHBD_SERVICE_HTTP_GITHUB_AUTHZ_USERS_YAML_URL}

ENV ORG_TECHBD_HUB_PRIME_LOG_FILE=${ORG_TECHBD_HUB_PRIME_LOG_FILE}

RUN git clone --depth 1 --branch ${TAG} ${REPO_URL}

# open the port for the fhir server
EXPOSE 8080

# Generate the site content
WORKDIR /app/polyglot-prime/hub-prime
RUN mvn site

# start the fhir server
WORKDIR /app/polyglot-prime/hub-prime
COPY postgresql-42.2.5.jar postgresql-42.2.5.jar
COPY schemaspy-6.2.4.jar schemaspy-6.2.4.jar
COPY start.sh /app/polyglot-prime/hub-prime/start.sh

# Convert to executable
RUN chmod +x /app/polyglot-prime/hub-prime/start.sh

#CMD ["mvn", "spring-boot:run", "-Dspring-boot.run.arguments=--server.port=8080 --server.host=0.0.0.0"]
ENTRYPOINT ["/app/polyglot-prime/hub-prime/start.sh"]
